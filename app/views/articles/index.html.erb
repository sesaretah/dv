<div class="row row-cards row-deck">
  <div class="col-lg-3">
    <div class="row">
      <div class="col-md-6 col-lg-12">
        <div class="card">
          <div class="card-body">

          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-12">
        <div class="card">
          <div class="card-body">

          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="card">
                  <div class="table-responsive">
                    <table class="table table-hover table-outline table-vcenter text-nowrap card-table">
                      <thead>
                        <tr>
                          <th class="text-center w-1">#</th>
                          <th><%=t :title%></th>
                          <th><%=t :progress%></th>
                          <th><%=t :workflow_state %></th>
                          <th class="text-center"><i class="icon-settings"></i></th>
                        </tr>
                      </thead>
                      <tbody>
                        <%@i = 1%>
                        <% for article in @articles%>
                        <tr>
                          <td class="text-center">
                            <%= @i%><%@i += 1%>
                          </td>
                          <td>
                            <div><%= truncate(article.title, length: 40)%></div>
                            <div class="small text-muted">
                              <%= truncate(article.abstract, length: 30)%>
                            </div>
                          </td>
                          <td>
                            <div class="clearfix">
                              <div class="float-left">
                                <strong id="progress_percent_<%= article.id%>">0%</strong>
                              </div>
                              <div class="float-right">
                                <small class="text-muted">
                                  <span>
                                    <% @jalali = JalaliDate.to_jalali(article.updated_at)%>
                                    <%= @jalali.year%>/<%= @jalali.month%>/<%= @jalali.day%>
                                  </span>
                                </small>
                              </div>
                            </div>
                            <div class="progress progress-xs">
                              <% if article.workflow_state%>
                              <% @workflow_states = WorkflowState.where(workflow_id: article.workflow_state.workflow.id).count%>
                                <div id="progress_bar_<%= article.id%>" class="progress-bar bg-yellow" role="progressbar" style="width: 42%" aria-valuenow="42" aria-valuemin="0" aria-valuemax="100"></div>
                                <p id='nodes_<%= article.id%>' style="display:none"><%= raw article.workflow_state.workflow.nodes%></p>
                                <p id='edges_<%= article.id%>' style="display:none"><%= raw article.workflow_state.workflow.edges%></p>
                                <p id='current_node_<%= article.id%>'><%= article.workflow_state.node_id%></p>
                                <script>
                                $( document ).on('turbolinks:load', function() {

                                var nodes = JSON.parse($('#nodes_<%= article.id%>').text());
                                var edges = JSON.parse($('#edges_<%= article.id%>').text());
                                var current_node = parseInt($('#current_node_<%= article.id%>').text());
                                var g = new graphlib.Graph();
                                async.series([
                                  function(callback) {
                                    for (var i = 0, len = nodes.length; i < len; i++) {
                                        g.setNode(nodes[i]['id']);
                                        if (i == len - 1){
                                          callback(null, 'one');
                                        }
                                    }
                                  },
                                  function(callback) {
                                    for (var i = 0, len = edges.length; i < len; i++) {
                                        g.setEdge(edges[i]['source']['id'], edges[i]['target']['id']);
                                        if (i == len - 1){
                                          callback(null, 'two');
                                        }
                                    }
                                  }
                                ],
                                // optional callback
                                function(err, results) {
                                  var d = graphlib.alg.dijkstra(g, current_node);
                                  console.log(Object.keys(d));
                                  var max = 0;
                                  for (var i = 0, len = Object.keys(d).length; i < len; i++) {
                                    console.log(d[Object.keys(d)[i]]);
                                    if (d[Object.keys(d)[i]]['distance'] > max){
                                      max = d[Object.keys(d)[i]]['distance']
                                    }
                                    if (i == len - 1){
                                      var percent = ((g.nodes().length -  max)/ g.nodes().length) * 100;
                                      $('#progress_bar_<%= article.id%>').attr('style', "width:" + percent +"%;");
                                      $('#progress_bar_<%= article.id%>').attr('aria-valuenow', percent);
                                      $('#progress_percent_<%= article.id%>').text( Math.round(percent)+'%');
                                    }
                                  }
                                });
                              });
                                </script>
                              <%else%>
                              <div class="progress-bar bg-red" role="progressbar" style="width: 2%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                              <%end%>
                            </div>
                          </td>
                          <td>
                            <% if article.workflow_state%>
                              <div class="small text-muted"><%= article.workflow_state.workflow.title%></div>
                              <div style="font-size:smaller;"><%= article.workflow_state.title%></div>
                            <%else%>
                              <div class="small text-muted"><i class="fe fe-alert-triangle" style="vertical-align:-3px;"></i> <%=t :without_workflow%></div>
                            <%end%>
                          </td>

                          <td class="text-center">
                            <div class="item-action dropdown">
                              <a href="javascript:void(0)" data-toggle="dropdown" class="icon"><i class="fe fe-more-vertical"></i></a>
                              <div class="dropdown-menu dropdown-menu-right">
                                <a href="/articles/<%= article.id%>" class="dropdown-item"><i class="dropdown-icon fe fe-play"></i><%=t :show%> </a>
                                <a href="/articles/<%= article.id%>/edit" class="dropdown-item"><i class="dropdown-icon fe fe-edit-2"></i> <%=t :edit%> </a>
                                <%= link_to article, method: :delete, class: "dropdown-item" ,data: { confirm: 'Are you sure?' } do %>
                                  <i class="dropdown-icon fe fe-trash"></i> <%=t :destroy%>
                                <%end%>
                                <div class="dropdown-divider"></div>
                                <a href="javascript:void(0)" class="dropdown-item"><i class="dropdown-icon fe fe-link"></i> <%=t :copy_aoi%></a>
                              </div>
                            </div>
                          </td>
                        </tr>
                        <%end%>
                                            </tbody>
                    </table>
                  </div>
                </div>
  </div>


</div>
